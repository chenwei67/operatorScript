# collect.sh 指标采集清单（CK -> SR 迁移）

默认输出目录：

- `OUTPUT_DIR` 未指定时为 `$(pwd)/output`（见脚本参数处理逻辑）
- 目录结构：`$OUTPUT_DIR/`、`$OUTPUT_DIR/timeseries/`、`$OUTPUT_DIR/snapshots/`

压力风险说明（粗略）：

- 高：可能对线上 ClickHouse（尤其是 `system.query_log`/业务大表）造成明显 CPU/IO/内存压力
- 中：对 ClickHouse 有可见压力，但通常可通过缩短窗口/限制线程缓解
- 低：通常影响有限（但在超大集群/极端基数下仍可能变慢）

| 采集内容/指标                                             | 统计方式或公式（脚本口径）                                                                                                                                                                         | 导出文件路径（相对 `$OUTPUT_DIR`）                             | 压力风险                                       |
| --------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- | ---------------------------------------------- |
| 汇总 JSON（总入口）                                       | 聚合所有输出路径与关键摘要字段                                                                                                                                                                     | `migration_metrics.json`                                       | 低                                             |
| Helm release 用户 values                                  | `helm list` 枚举后 `helm get values` 导出                                                                                                                                                      | `helm/<release>.yaml`                                          | 低                                             |
| ClickHouse 版本                                           | `SELECT version()`                                                                                                                                                                               | 写入 JSON（不单独落 CSV）                                        | 低                                             |
| K8s 节点清单（inventory）                                 | `kubectl get nodes ... jsonpath` 抽取节点 CPU/内存/OS 等                                                                                                                                         | `snapshots/cluster_k8s_nodes.csv`                              | 低                                             |
| ClickHouse 集群存储卷信息（system.disks）                 | `clusterAllReplicas(..., system.disks)` 按节点输出磁盘/路径/容量                                                                                                                                 | `snapshots/cluster_storage_volumes.csv`                        | 低                                             |
| 全量表统计（行数/压缩/解压大小）                          | `clusterAllReplicas(system.tables)` + `clusterAllReplicas(system.parts)`（仅 replica_num=1）聚合 `sum(rows/bytes)` 后 LEFT JOIN 到所有表                                                     | `table_stats.csv`                                              | 中                                             |
| business 表 TTL 元数据                                    | 从 `system.tables.engine_full` 提取 TTL 表达式并正则抽 TTL 数值                                                                                                                                  | `business_ttl.csv`                                             | 低                                             |
| 全量表 schema（列级）                                     | `system.columns` 全量导出（排除 system 库）                                                                                                                                                      | `table_schema.csv`                                             | 低-中                                          |
| system.settings                                           | `SELECT name,value,changed,description FROM system.settings`                                                                                                                                     | `snapshots/system_settings.csv`                                | 低                                             |
| system.build_options                                      | `SELECT name,value FROM system.build_options`                                                                                                                                                    | `snapshots/system_build_options.csv`                           | 低                                             |
| business 表“写入行数”分桶时序（逐表）                   | 对 business-time-config 中每张表执行：`WHERE time_expr >= now()-N day`，按 `toStartOfInterval(time_expr, bucket)` 分组统计 `count()`                                                         | `timeseries/business_table_writes/<db>/<table>.csv`            | 高                                             |
| query_log：Insert 按表分桶（次数/写入行数）               | `clusterAllReplicas(system.query_log)` + `ARRAY JOIN arrayEnumerate(databases)`，过滤 `QueryFinish/is_initial_query/query_kind=Insert`，按表+时间桶聚合 `count()` 与 `sum(written_rows)` | `timeseries/query_log_writes/<db.table>.csv`（目录内拆分文件） | 中-高                                          |
| query_log：Select 按表分桶（次数）                        | 同上，过滤 `query_kind=Select`，按表+时间桶聚合 `count()`                                                                                                                                      | `timeseries/query_log_reads/<db.table>.csv`（目录内拆分文件）  | 中-高                                          |
| query_log written_bytes 时序（优先 query_log，否则回退）  | 优先：`sum(written_rows/written_bytes)`；回退：`system.part_log` NewPart；再回退：`system.parts` 按 modification_time 近似                                                                   | `timeseries/query_log_written_bytes_timeseries.csv`            | 中                                             |
| query_log 延迟画像（p50/p95/p99/avg） + 读字节 + 内存峰值 | `clusterAllReplicas(system.query_log)` 过滤 `QueryFinish/is_initial_query`，按 `query_kind + 时间桶` 聚合：`quantile/avg/sum(read_bytes)/max(memory_usage)`                                | `timeseries/query_log_latency_timeseries.csv`                  | 高                                             |
| 近 N 天 Top 慢查询（按 normalized_query 聚合）           | `GROUP BY normalized_query`，聚合 `count/quantile(0.95)/avg/sum(read_bytes)/max(memory_usage)`，`ORDER BY p95 DESC LIMIT N`                                                                  | `slow_queries_top.csv`                                         | 高                                             |
| 查询时间范围分布（按表）                                  | 扫 `system.query_log`，对 `ql.query` 做多种正则解析（INTERVAL/日期/时间戳/字段条件），估算每条查询的“时间范围天数”，再按表统计比例与分位数；带 `SETTINGS max_threads/max_execution_time`   | `query_time_range_distribution.csv`                            | 高                                             |
| parts/partitions 压力快照                                 | `clusterAllReplicas(system.parts)`（仅 replica_num=1）按表聚合：`count(active_parts) / uniqExact(partition) / sum(rows/bytes) / max(part_bytes)`                                               | `snapshots/cluster_parts_snapshot.csv`                         | 中                                             |
| merges 快照                                               | `clusterAllReplicas(system.merges)` 按节点聚合：`count()/sum(num_parts)/sum(total_size_bytes_compressed)`                                                                                      | `snapshots/cluster_merges_snapshot.csv`                        | 低-中                                          |
| mutations 快照                                            | `clusterAllReplicas(system.mutations)` 过滤 `is_done=0`，按表聚合未完成数量                                                                                                                    | `snapshots/cluster_mutations_snapshot.csv`                     | 低-中                                          |
| 节点磁盘使用明细（来自 VM 瞬时查询）                      | VictoriaMetrics `api/v1/query` 拉 `node_filesystem_size/free`，拼出 used/used%                                                                                                                 | `snapshots/cluster_node_disk_usage.csv`                        | 低（对 CK）/中（对 VM）                        |
| CK Pod 资源时序（来自 VM query_range）                    | 多条 PromQL：CPU/内存/网络/磁盘 IO/限流等；按窗口做 `avg_over_time/max_over_time`                                                                                                                | `timeseries/ck_pod_usage_timeseries.prom`                      | 低（对 CK）/中（对 VM）                        |
| 集群节点资源时序（来自 VM query_range）                   | 多条 PromQL：节点 CPU/内存/磁盘/负载/Swap/网络/IO；按窗口 `avg/max`                                                                                                                              | `timeseries/cluster_node_usage_timeseries.prom`                | 低（对 CK）/中（对 VM）                        |
| 归档压缩包（可选）                                        | `tar -czf "${OUTPUT_DIR}.tar.gz"`，成功后删除原目录 | `${OUTPUT_DIR}.tar.gz`（与输出目录同级）                                                                                                 | 低                                                               | 便于跨环境传输与留档，支持审计、复盘与离线分析 |
